<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="shinytest2">
<title>Auditing Shiny apps • shinytest2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.2/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.2/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Auditing Shiny apps">
<meta property="og:description" content="shinytest2">
<meta property="og:image" content="https://rstudio.github.io/shinytest2/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-none"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">shinytest2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/shinytest2.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/in-depth.html">Testing in depth</a>
    <a class="dropdown-item" href="../articles/robust.html">Robust testing</a>
    <a class="dropdown-item" href="../articles/use-application-audit.html">Auditing Shiny apps</a>
    <a class="dropdown-item" href="../articles/use-ci.html">Using shinytest2 with continuous integration</a>
    <a class="dropdown-item" href="../articles/use-package.html">Using shinytest2 with R packages</a>
    <a class="dropdown-item" href="../articles/using-monkey-testing.html">Monkey testing</a>
    <a class="dropdown-item" href="../articles/z-migration.html">Migrating from shinytest</a>
    <a class="dropdown-item" href="../articles/zzz-faq.html">Frequently Asked Questions</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/rstudio/shinytest2/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article" id="container">



<script src="use-application-audit_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Auditing Shiny apps</h1>
                        <h4 data-toc-skip class="author">David Granjon</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/shinytest2/blob/HEAD/vignettes/use-application-audit.Rmd" class="external-link"><code>vignettes/use-application-audit.Rmd</code></a></small>
      <div class="d-none name"><code>use-application-audit.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="audit-shiny-apps-with-shinytest2">Audit Shiny apps with {shinytest2}<a class="anchor" aria-label="anchor" href="#audit-shiny-apps-with-shinytest2"></a>
</h2>
<p>Have you ever dreamed of profiling, load testing your Shiny app at each commit, without having to manually run any script?</p>
<p>In this vignette, we’ll see how one can design and automate Shiny apps audit pipelines with <a href="https://rstudio.github.io/shinytest2/">shinytest2</a>.</p>
<div class="section level3">
<h3 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h3>
<p>This case study consists of analyzing a particularly non-optimized app, whose code is defined below. This app simulates a stiff oscillator, also known as Van der Pol <a href="https://en.wikipedia.org/wiki/Van_der_Pol_oscillator" class="external-link">model</a>. Under the hood, this system (composed of 2 differential equations) is integrated with the <a href="http://desolve.r-forge.r-project.org/" class="external-link">deSolve</a> package. Stiff systems need a much smaller time step than classic systems, thereby requiring more time to solve:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">van_der_pol</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">y</span>, <span class="va">mu</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">d_x</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">d_y</span> <span class="op">&lt;-</span> <span class="va">mu</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">y</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="va">y</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">y</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">d_x</span>, Y <span class="op">=</span> <span class="va">d_y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">brussels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPlot.html" class="external-link">renderPlot</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">y0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">X</span>, Y <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span></span>
<span>    <span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1000</span>, <span class="fl">.01</span><span class="op">)</span></span>
<span>    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">ode</span><span class="op">(</span><span class="va">y0</span>, <span class="va">times</span>, <span class="va">van_der_pol</span>, <span class="va">input</span><span class="op">$</span><span class="va">mu</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">out</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"l"</span>, xlab <span class="op">=</span> <span class="st">"X"</span>, ylab <span class="op">=</span> <span class="st">"Y"</span>, main <span class="op">=</span> <span class="st">"state diagram"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html" class="external-link">fluidPage</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/headerPanel.html" class="external-link">headerPanel</a></span><span class="op">(</span><span class="st">"Van der Pol oscillator"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/sidebarLayout.html" class="external-link">sidebarLayout</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/sidebarLayout.html" class="external-link">sidebarPanel</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html" class="external-link">h3</a></span><span class="op">(</span><span class="st">"Init values"</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html" class="external-link">numericInput</a></span><span class="op">(</span><span class="st">"X"</span>, label <span class="op">=</span> <span class="st">"X"</span>, min <span class="op">=</span> <span class="fl">0.0</span>, max <span class="op">=</span> <span class="fl">5</span>,  value <span class="op">=</span> <span class="fl">1</span>, step <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html" class="external-link">numericInput</a></span><span class="op">(</span><span class="st">"Y"</span>, label <span class="op">=</span> <span class="st">"Y"</span>, min <span class="op">=</span> <span class="fl">0.0</span>, max <span class="op">=</span> <span class="fl">5</span>,  value <span class="op">=</span> <span class="fl">1</span>, step <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>,</span>
<span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html" class="external-link">h3</a></span><span class="op">(</span><span class="st">"Parameters"</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html" class="external-link">numericInput</a></span><span class="op">(</span><span class="st">"mu"</span>, label <span class="op">=</span> <span class="st">"mu"</span>, min <span class="op">=</span> <span class="fl">0.0</span>, max <span class="op">=</span> <span class="fl">5</span>,  value <span class="op">=</span> <span class="fl">1</span>, step <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/sidebarLayout.html" class="external-link">mainPanel</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html" class="external-link">h3</a></span><span class="op">(</span><span class="st">"Simulation results"</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/plotOutput.html" class="external-link">plotOutput</a></span><span class="op">(</span><span class="st">"brussels"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html" class="external-link">shinyApp</a></span><span class="op">(</span>ui <span class="op">=</span> <span class="va">ui</span>, server <span class="op">=</span> <span class="va">server</span><span class="op">)</span></span></code></pre></div>
<p>As a first test, you can run the app by calling <code>runApp(system.file("vig-apps/non-optimized-app/", package = "shinytest2"))</code> locally and notice how slow it is to perform one computation. The next question is, how does this app scale? The answer is likely “No it doesn’t!”, but we would like to know exactly how bad it is. This is where load testing comes to play.</p>
</div>
<div class="section level3">
<h3 id="load-testing-with-shinytest2">Load testing with {shinytest2}<a class="anchor" aria-label="anchor" href="#load-testing-with-shinytest2"></a>
</h3>
<p>Shiny app <a href="https://rstudio.github.io/shinyloadtest/index.html" class="external-link">load testing</a> aims at running multiple identical user sessions in parallel and measure the resulting app response. It answers many questions, such as:</p>
<ul>
<li>What is the time necessary to get to the homepage?</li>
<li>How much time does it take to perform the first computation?</li>
<li>Will all session end at the same time?</li>
</ul>
<p>A load test is composed a three phases:</p>
<ul>
<li>Similarly to <a href="https://rstudio.github.io/shinytest2/">shinytest2</a>, <a href="https://rstudio.github.io/shinyloadtest/" class="external-link">shinyloadtest</a> records a user session with <code>shinyloadtest::record_session()</code>.</li>
<li>This session is subsequently replayed by a Java-based tool, <code>shinycannon</code>, able to simulate multiple sessions during a chosen amount of time.</li>
<li>Sessions are analyzed by <code>shinyloadtest::load_runs()</code> and an HTML report generated with <code>shinyloadtest::shinyloadtest_report()</code>.</li>
</ul>
<p>In general, the first step is done manually, that is, you play with the app as if you were a real business user and stop the session when satisfied. However, because of <a href="https://rstudio.github.io/shinytest2/">shinytest2</a> headless capabilities, we could manipulate the app with <a href="https://rstudio.github.io/shinytest2/">shinytest2</a> helpers such as <code>set_inputs</code> or raw JavaScript code to achieve the same goal.</p>
<p>There is, however, a tiny technical obstacle to overcome. By default, <a href="https://rstudio.github.io/shinytest2/">shinytest2</a> starts the app on a given port and the headless browser, namely Chrome, is then connected to the same port. This would be an issue with <a href="https://rstudio.github.io/shinyloadtest/" class="external-link">shinyloadtest</a> since the recorder does not listen to the same port, which is <code>8600</code>. In practice, we’ll have to:</p>
<ul>
<li>Start the Shiny app as a background process on a given port.</li>
<li>Fire the load test recorder on port <code>8600</code>.</li>
<li>Connect Chrome to the recorder on port <code>8600</code>.</li>
</ul>
<div class="section level4">
<h4 id="launch-the-background-app">Launch the background app<a class="anchor" aria-label="anchor" href="#launch-the-background-app"></a>
</h4>
<p>You may have already noticed that when launching a Shiny app, you can’t run anything else in the R console while the app is live. The explanation is pretty simple: R performs tasks sequentially and can only perform one calculation at a time.</p>
<p>How do we start the app without blocking the main R process? We leverage the <a href="https://callr.r-lib.org" class="external-link">callr</a> package, which exposes a convenient API to start R processes in the background, that is, without blocking the main R process. The code below shows how to start a Shiny app located at <code>path</code> on a specific port and run the load test recorder on the same port:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Main shiny app</span></span>
<span><span class="va">shiny_bg</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">path</span>, <span class="va">port</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>shiny.port <span class="op">=</span> <span class="va">port</span><span class="op">)</span></span>
<span>  <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/runApp.html" class="external-link">runApp</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Start recorder</span></span>
<span><span class="va">recorder_bg</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">port</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">shinyloadtest</span><span class="fu">::</span><span class="fu">record_session</span><span class="op">(</span></span>
<span>    target_app_url <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"http://127.0.0.1:%s"</span>, <span class="va">port</span><span class="op">)</span>,</span>
<span>    host <span class="op">=</span> <span class="st">"127.0.0.1"</span>,</span>
<span>    port <span class="op">=</span> <span class="fl">8600</span>,</span>
<span>    output_file <span class="op">=</span> <span class="st">"recording.log"</span>,</span>
<span>    open_browser <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can pass this to the <code>start_r_bg()</code> function:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">start_r_bg</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fun</span>, <span class="va">path</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">port</span> <span class="op">=</span> <span class="fl">3515</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># remove NULL elements</span></span>
<span>  <span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Negate</a></span><span class="op">(</span><span class="va">is.null</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">path</span>, port <span class="op">=</span> <span class="va">port</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">process</span> <span class="op">&lt;-</span> <span class="fu">callr</span><span class="fu">::</span><span class="fu"><a href="https://callr.r-lib.org/reference/r_bg.html" class="external-link">r_bg</a></span><span class="op">(</span></span>
<span>    func <span class="op">=</span> <span class="va">fun</span>,</span>
<span>    args <span class="op">=</span> <span class="va">args</span>,</span>
<span>    stderr<span class="op">=</span> <span class="st">""</span>,</span>
<span>    stdout <span class="op">=</span> <span class="st">""</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw">while</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu">pingr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pingr/man/ping_port.html" class="external-link">ping_port</a></span><span class="op">(</span><span class="st">"127.0.0.1"</span>, <span class="fl">3515</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Waiting for Shiny app to start..."</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu">attempt</span><span class="fu">::</span><span class="fu">stop_if_not</span><span class="op">(</span></span>
<span>    <span class="va">process</span><span class="op">$</span><span class="fu">is_alive</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    msg <span class="op">=</span> <span class="st">"Unable to launch the subprocess"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">process</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>where <code>r_bg()</code> starts a background R process, passing the corresponding function and parameters. Besides, we provide some log elements and safety guard in case the app can’t start. To launch the app and recorder we can call:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fu">start_r_bg</span><span class="op">(</span><span class="va">shiny_bg</span>, path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"vig-apps/non-optimized-app/"</span>, package <span class="op">=</span> <span class="st">"shinytest2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Listening on 127.0.0.1:3515</span></span>
<span><span class="va">recorder</span> <span class="op">&lt;-</span> <span class="fu">start_r_bg</span><span class="op">(</span><span class="va">recorder_bg</span><span class="op">)</span></span>
<span><span class="co"># Listening on 127.0.0.1:8600</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="connect-chrome">Connect Chrome<a class="anchor" aria-label="anchor" href="#connect-chrome"></a>
</h4>
<p>The previous part was the most technical step. Now, we only have to start a Chrome headless browser on port <code>8600</code>, where the load test recorder runs. You’ll notice that <a href="https://rstudio.github.io/shinytest2/">shinytest2</a> also supports remote urls. We should increase the value of <code>load_timout</code> to 15 seconds to help us avoid producing this annoying <a href="https://rstudio.github.io/shinytest2/">shinytest2</a> warning:</p>
<pre><code>{shinytest2} R  info 15:25:37.36 Error while initializing AppDriver:
Shiny app did not become stable in 10000ms.</code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Start AppDriver with recorder url</span></span>
<span><span class="va">chrome</span> <span class="op">&lt;-</span> <span class="fu">shinytest2</span><span class="fu">::</span><span class="va"><a href="../reference/AppDriver.html">AppDriver</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"http://127.0.0.1:8600"</span>, load_timeout <span class="op">=</span> <span class="fl">15</span> <span class="op">*</span> <span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
<p>If your running under Linux OS, below shows the list of R processes running so far in the background:</p>
<pre><code>$ netstat -lntp

Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 127.0.0.1:8600          0.0.0.0:*               LISTEN      361115/R
tcp        0      0 127.0.0.1:3515          0.0.0.0:*               LISTEN      361101/R
tcp        0      0 127.0.0.1:44179         0.0.0.0:*               LISTEN      359555/google-chrom</code></pre>
<p>If everything is successful, you should see a <strong>Client connected</strong> message in the R console. We then change the <code>mu</code> parameter input without forgetting the timeout:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">app</span><span class="op">$</span><span class="fu">set_inputs</span><span class="op">(</span>mu <span class="op">=</span> <span class="fl">4</span>, timeout_ <span class="op">=</span> <span class="fl">15</span> <span class="op">*</span> <span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
<p>We can inspect the logs with the help of <code>chrome$get_log()</code>, to check whether everything run smoothly:</p>
<pre><code><span><span class="va">app</span><span class="op">$</span><span class="fu">get_logs</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; {shinytest2} R  info 14:27:00.80 Start AppDriver initialization</span></span>
<span><span class="co">#&gt; {shinytest2} R  info 14:27:00.82 Creating new ChromoteSession</span></span>
<span><span class="co">#&gt; {shinytest2} R  info 14:27:02.20 Navigating to Shiny app</span></span>
<span><span class="co">#&gt; {shinytest2} R  info 14:27:02.57 Injecting shiny-tracer.js</span></span>
<span><span class="co">#&gt; {chromote}   JS info 14:27:02.61 shinytest2; jQuery not found</span></span>
<span><span class="co">#&gt; {chromote}   JS info 14:27:02.63 shinytest2; Loaded</span></span>
<span><span class="co">#&gt; {shinytest2} R  info 14:27:02.64 Waiting for Shiny to become ready</span></span>
<span><span class="co">#&gt; {chromote}   JS info 14:27:02.72 shinytest2; jQuery found</span></span>
<span><span class="co">#&gt; {chromote}   JS info 14:27:02.73 shinytest2; Waiting for shiny session to connect</span></span>
<span><span class="co">#&gt; {chromote}   JS info 14:27:03.12 shinytest2; Connected</span></span>
<span><span class="co">#&gt; {shinytest2} R  info 14:27:03.17 Waiting for Shiny to become idle for 200ms within 10000ms</span></span>
<span><span class="co">#&gt; {chromote}   JS info 14:27:03.18 shinytest2; Waiting for Shiny to be stable</span></span>
<span><span class="co">#&gt; {chromote}   JS info 14:27:03.27 shinytest2; shiny:busy</span></span>
<span><span class="co">#&gt; {chromote}   JS info 14:27:06.28 shinytest2; shiny:idle</span></span>
<span><span class="co">#&gt; {chromote}   JS info 14:27:06.30 shinytest2; shiny:value brussels</span></span>
<span><span class="co">#&gt; {chromote}   JS info 14:27:06.48 shinytest2; Shiny has been idle for 200ms</span></span>
<span><span class="co">#&gt; {shinytest2} R  info 14:27:06.48 Shiny app started</span></span>
<span><span class="co">#&gt; {shinytest2} R  info 14:30:17.79 Setting inputs: 'mu'', ''X'', ''Y'</span></span>
<span><span class="co">#&gt; {chromote}   JS info 14:30:17.81 shinytest2; inputQueue: adding mu</span></span>
<span><span class="co">#&gt; {chromote}   JS info 14:30:17.81 shinytest2; inputQueue: adding X</span></span>
<span><span class="co">#&gt; {chromote}   JS info 14:30:17.81 shinytest2; inputQueue: adding Y</span></span>
<span><span class="co">#&gt; {chromote}   JS info 14:30:17.82 shinytest2; inputQueue: flushing mu</span></span>
<span><span class="co">#&gt; {chromote}   JS info 14:30:17.83 shinytest2; inputQueue: flushing X</span></span>
<span><span class="co">#&gt; {chromote}   JS info 14:30:17.83 shinytest2; inputQueue: flushing Y</span></span>
<span><span class="co">#&gt; {chromote}   JS info 14:30:17.87 shinytest2; shiny:busy</span></span>
<span><span class="co">#&gt; {chromote}   JS info 14:30:20.42 shinytest2; shiny:idle</span></span>
<span><span class="co">#&gt; {chromote}   JS info 14:30:20.46 shinytest2; shiny:value brussels</span></span>
<span><span class="co">#&gt; {shinytest2} R  info 14:30:20.47 Finished setting inputs. Timedout: FALSE</span></span></code></pre>
<p>Once satisfied, we may close the headless connection to stop the recorder:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># clean</span></span>
<span><span class="va">app</span><span class="op">$</span><span class="kw">stop</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># needed to avoid</span></span>
<span><span class="co"># java.lang.IllegalStateException: last event in log not a</span></span>
<span><span class="co"># WS_CLOSE (did you close the tab after recording?)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="replay-with-shinycannon">Replay with shinycannon<a class="anchor" aria-label="anchor" href="#replay-with-shinycannon"></a>
</h4>
<p>If you remember, the final step consists of replaying the main session in parallel. We start <code>shinycannon</code> with 5 workers and wait:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">target_url</span> <span class="op">&lt;-</span> <span class="st">"http://127.0.0.1:3515"</span></span>
<span><span class="va">workers</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>    <span class="st">"shinycannon recording.log %s --workers %s --loaded-duration-minutes 2 --output-dir run1"</span>,</span>
<span>    <span class="va">target_url</span>, <span class="va">workers</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># shinycannon replay</span></span>
<span><span class="co">#2022-05-09 14:37:18.549 INFO [thread00] - Detected target application type: R/Shiny</span></span>
<span><span class="co">#2022-05-09 14:37:18.560 INFO [thread00] - Waiting for warmup to complete</span></span>
<span><span class="co">#2022-05-09 14:37:18.554 INFO [thread01] - Warming up</span></span>
<span><span class="co">#2022-05-09 14:37:18.562 INFO [progress] - Running: 0, Failed: 0, Done: 0</span></span>
<span><span class="co">#2022-05-09 14:37:23.563 INFO [progress] - Running: 1, Failed: 0, Done: 0</span></span></code></pre></div>
<p>Some error message in the <code>shinycannon</code> logs can be explained by failures during the <a href="https://rstudio.github.io/shinytest2/">shinytest2</a> driver initialization. If this error persist, best practice is to restart R, cleanup everything and start again.</p>
</div>
<div class="section level4">
<h4 id="report-generation">Report generation<a class="anchor" aria-label="anchor" href="#report-generation"></a>
</h4>
<p>The report generation is quite straightforward:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Close the running app</span></span>
<span><span class="va">target</span><span class="op">$</span><span class="fu">kill</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Treat data and generate report</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">shinyloadtest</span><span class="fu">::</span><span class="fu">load_runs</span><span class="op">(</span><span class="st">"run1"</span><span class="op">)</span></span>
<span><span class="fu">shinyloadtest</span><span class="fu">::</span><span class="fu">shinyloadtest_report</span><span class="op">(</span></span>
<span>  <span class="va">df</span>,</span>
<span>  <span class="st">"public/index.html"</span>,</span>
<span>  self_contained <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  open_browser <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We don’t forget to clean the target app so as to kill the underlying process. Note that if you want to deploy the report on GitHub Pages, you have to name it <code>index.html</code>.</p>
</div>
<div class="section level4">
<h4 id="automating-with-github-actions">Automating with GitHub Actions<a class="anchor" aria-label="anchor" href="#automating-with-github-actions"></a>
</h4>
<p>Now, it is time to integrate the current pipeline in a CI/CD workflow. For convenience, we wrap all the previous steps in a single function:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## File: R/audit-app.R</span></span>
<span><span class="va">record_loadtest</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">path</span>, <span class="va">timeout</span> <span class="op">=</span> <span class="fl">15</span>, <span class="va">workers</span> <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"\n---- BEGIN LOAD-TEST ---- \n"</span><span class="op">)</span></span>
<span>  <span class="co"># start app + recorder</span></span>
<span>  <span class="va">target</span> <span class="op">&lt;-</span> <span class="fu">start_r_bg</span><span class="op">(</span><span class="va">shiny_bg</span>, path <span class="op">=</span> <span class="va">path</span><span class="op">)</span></span>
<span>  <span class="va">recorder</span> <span class="op">&lt;-</span> <span class="fu">start_r_bg</span><span class="op">(</span><span class="va">recorder_bg</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># start headless chrome (points to recorder!).</span></span>
<span>  <span class="co"># AppDriver also support remote urls.</span></span>
<span>  <span class="va">app</span> <span class="op">&lt;-</span> <span class="fu">shinytest2</span><span class="fu">::</span><span class="va"><a href="../reference/AppDriver.html">AppDriver</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    <span class="st">"http://127.0.0.1:8600"</span>,</span>
<span>    load_timeout <span class="op">=</span> <span class="va">timeout</span> <span class="op">*</span> <span class="fl">1000</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">app</span><span class="op">$</span><span class="fu">set_inputs</span><span class="op">(</span>mu <span class="op">=</span> <span class="fl">4</span>, timeout_ <span class="op">=</span> <span class="va">timeout</span> <span class="op">*</span> <span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># clean</span></span>
<span>  <span class="va">app</span><span class="op">$</span><span class="kw">stop</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="co"># needed to avoid</span></span>
<span>  <span class="co"># java.lang.IllegalStateException: last event in log not a</span></span>
<span>  <span class="co"># WS_CLOSE (did you close the tab after recording?)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># shinycannon (maybe expose other params later ...)</span></span>
<span>  <span class="va">target_url</span> <span class="op">&lt;-</span> <span class="st">"http://127.0.0.1:3515"</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>      <span class="st">"shinycannon recording.log %s --workers %s --loaded-duration-minutes 2 --output-dir run1"</span>,</span>
<span>      <span class="va">target_url</span>, <span class="va">workers</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">target</span><span class="op">$</span><span class="fu">kill</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Treat data and generate report</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">shinyloadtest</span><span class="fu">::</span><span class="fu">load_runs</span><span class="op">(</span><span class="st">"run1"</span><span class="op">)</span></span>
<span>  <span class="fu">shinyloadtest</span><span class="fu">::</span><span class="fu">shinyloadtest_report</span><span class="op">(</span></span>
<span>    <span class="va">df</span>,</span>
<span>    <span class="st">"public/index.html"</span>,</span>
<span>    self_contained <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    open_browser <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Below is the necessary GitHub Actions yaml file. Overall, this will:</p>
<ul>
<li>Run each time code is pushed to GitHub.</li>
<li>Run in parallel on 3 different Ubuntu flavors.</li>
<li>Install R, some system dependencies, and R packages. Install shinycannon tools for load-testing.</li>
<li>Deploy the load test report to GitHub Pages.</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">main</span><span class="kw">,</span><span class="at"> master</span><span class="kw">]</span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="at">  </span><span class="fu">pull_request</span><span class="kw">:</span></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">main</span><span class="kw">,</span><span class="at"> master</span><span class="kw">]</span></span>
<span id="cb14-6"><a href="#cb14-6"></a></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> shiny-loadtest-ci</span></span>
<span id="cb14-8"><a href="#cb14-8"></a></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="at">  </span><span class="fu">shiny-loadtest-ci</span><span class="kw">:</span></span>
<span id="cb14-11"><a href="#cb14-11"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ${{ matrix.config.os }}</span></span>
<span id="cb14-12"><a href="#cb14-12"></a><span class="at">    </span><span class="fu">permissions</span><span class="kw">:</span></span>
<span id="cb14-13"><a href="#cb14-13"></a><span class="at">      </span><span class="fu">contents</span><span class="kw">:</span><span class="at"> write</span></span>
<span id="cb14-14"><a href="#cb14-14"></a></span>
<span id="cb14-15"><a href="#cb14-15"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> ${{ matrix.config.os }} (${{ matrix.config.r }})</span></span>
<span id="cb14-16"><a href="#cb14-16"></a></span>
<span id="cb14-17"><a href="#cb14-17"></a><span class="at">    </span><span class="fu">strategy</span><span class="kw">:</span></span>
<span id="cb14-18"><a href="#cb14-18"></a><span class="at">      </span><span class="fu">fail-fast</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb14-19"><a href="#cb14-19"></a><span class="at">      </span><span class="fu">matrix</span><span class="kw">:</span></span>
<span id="cb14-20"><a href="#cb14-20"></a><span class="at">        </span><span class="fu">config</span><span class="kw">:</span></span>
<span id="cb14-21"><a href="#cb14-21"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="kw">{</span><span class="fu">os</span><span class="kw">:</span><span class="at"> ubuntu-latest</span><span class="kw">,</span><span class="at">   </span><span class="fu">r</span><span class="kw">:</span><span class="at"> </span><span class="st">'devel'</span><span class="kw">,</span><span class="at"> </span><span class="fu">http-user-agent</span><span class="kw">:</span><span class="at"> </span><span class="st">'release'</span><span class="kw">}</span></span>
<span id="cb14-22"><a href="#cb14-22"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="kw">{</span><span class="fu">os</span><span class="kw">:</span><span class="at"> ubuntu-latest</span><span class="kw">,</span><span class="at">   </span><span class="fu">r</span><span class="kw">:</span><span class="at"> </span><span class="st">'release'</span><span class="kw">}</span></span>
<span id="cb14-23"><a href="#cb14-23"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="kw">{</span><span class="fu">os</span><span class="kw">:</span><span class="at"> ubuntu-latest</span><span class="kw">,</span><span class="at">   </span><span class="fu">r</span><span class="kw">:</span><span class="at"> </span><span class="st">'oldrel-1'</span><span class="kw">}</span></span>
<span id="cb14-24"><a href="#cb14-24"></a></span>
<span id="cb14-25"><a href="#cb14-25"></a><span class="at">    </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb14-26"><a href="#cb14-26"></a><span class="at">      </span><span class="fu">GITHUB_PAT</span><span class="kw">:</span><span class="at"> ${{ secrets.GITHUB_TOKEN }}</span></span>
<span id="cb14-27"><a href="#cb14-27"></a><span class="at">      </span><span class="fu">R_KEEP_PKG_SOURCE</span><span class="kw">:</span><span class="at"> </span><span class="ch">yes</span></span>
<span id="cb14-28"><a href="#cb14-28"></a></span>
<span id="cb14-29"><a href="#cb14-29"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb14-30"><a href="#cb14-30"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v2</span></span>
<span id="cb14-31"><a href="#cb14-31"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> r-lib/actions/setup-r@v2</span></span>
<span id="cb14-32"><a href="#cb14-32"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> r-lib/actions/setup-r-dependencies@v2</span></span>
<span id="cb14-33"><a href="#cb14-33"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb14-34"><a href="#cb14-34"></a><span class="at">          </span><span class="fu">cache-version</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb14-35"><a href="#cb14-35"></a><span class="fu">          extra-packages</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb14-36"><a href="#cb14-36"></a>            any::shinyloadtest</span>
<span id="cb14-37"><a href="#cb14-37"></a>            any::lubridate</span>
<span id="cb14-38"><a href="#cb14-38"></a>            any::DT</span>
<span id="cb14-39"><a href="#cb14-39"></a>            any::callr</span>
<span id="cb14-40"><a href="#cb14-40"></a>            any::shinytest2</span>
<span id="cb14-41"><a href="#cb14-41"></a>            any::deSolve</span>
<span id="cb14-42"><a href="#cb14-42"></a>            any::attempt</span>
<span id="cb14-43"><a href="#cb14-43"></a></span>
<span id="cb14-44"><a href="#cb14-44"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install shinycannon 💥</span></span>
<span id="cb14-45"><a href="#cb14-45"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb14-46"><a href="#cb14-46"></a>          sudo bash -c 'apt-get update; apt-get install -y default-jre-headless; apt-get clean; rm -rf /var/lib/apt/lists/*'</span>
<span id="cb14-47"><a href="#cb14-47"></a>          wget https://github.com/rstudio/shinycannon/releases/download/v1.1.3/shinycannon_1.1.3-dd43f6b_amd64.deb</span>
<span id="cb14-48"><a href="#cb14-48"></a>          sudo dpkg -i ./*.deb</span>
<span id="cb14-49"><a href="#cb14-49"></a></span>
<span id="cb14-50"><a href="#cb14-50"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run load test 🏥</span></span>
<span id="cb14-51"><a href="#cb14-51"></a><span class="at">        </span><span class="fu">shell</span><span class="kw">:</span><span class="at"> Rscript {0}</span></span>
<span id="cb14-52"><a href="#cb14-52"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb14-53"><a href="#cb14-53"></a>            source("R/audit-app.R")</span>
<span id="cb14-54"><a href="#cb14-54"></a>            record_loadtest(path = "app.R");</span>
<span id="cb14-55"><a href="#cb14-55"></a></span>
<span id="cb14-56"><a href="#cb14-56"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy to GitHub pages 🚀</span></span>
<span id="cb14-57"><a href="#cb14-57"></a><span class="at">        </span><span class="fu">if</span><span class="kw">:</span><span class="at"> github.event_name != 'pull_request'</span></span>
<span id="cb14-58"><a href="#cb14-58"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> JamesIves/github-pages-deploy-action@4.1.4</span></span>
<span id="cb14-59"><a href="#cb14-59"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb14-60"><a href="#cb14-60"></a><span class="at">          </span><span class="fu">clean</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb14-61"><a href="#cb14-61"></a><span class="at">          </span><span class="fu">branch</span><span class="kw">:</span><span class="at"> gh-pages</span></span>
<span id="cb14-62"><a href="#cb14-62"></a><span class="at">          </span><span class="fu">folder</span><span class="kw">:</span><span class="at"> public</span></span></code></pre></div>
<p>If you want to test it on your end, below are lines of code to setup a RStudio project and link it to GitHub:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Inside the project</span></span>
<span><span class="co"># Use audit GitHub Actions workflow</span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/github_actions.html" class="external-link">use_github_action</a></span><span class="op">(</span>url <span class="op">=</span> <span class="st">"https://raw.githubusercontent.com/rstudio/shinytest2/main/inst/gha/app-audit.yaml"</span><span class="op">)</span></span>
<span><span class="co"># Copy audit script</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">"R"</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.copy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"gha/audit-app.R"</span>, package <span class="op">=</span> <span class="st">"shinytest2"</span><span class="op">)</span>, <span class="st">"R/audit-app.R"</span><span class="op">)</span></span>
<span><span class="co"># Create your app.R file</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.create</a></span><span class="op">(</span><span class="st">"app.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"TODO: User - Copy in your app code to `app.R`!"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># To test it locally</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"R/audit-app.R"</span><span class="op">)</span></span>
<span><span class="fu">record_loadtest</span><span class="op">(</span><span class="st">"app.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Test the audit with GitHub Actions</span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_description.html" class="external-link">use_description</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_git.html" class="external-link">use_git</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_github.html" class="external-link">use_github</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_github_pages.html" class="external-link">use_github_pages</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>If you test it locally within a package, you may want to ignore <code>public</code>, <code>recording.log</code> by adding them in the <code>.Rbuildignore</code> file, which will avoid unnecessary warnings during any future <code>devtools::check()</code>:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_build_ignore.html" class="external-link">use_build_ignore</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"public"</span>, <span class="st">"recording.log"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>An example is available <a href="https://github.com/DivadNojnarg/shinyAuditTest" class="external-link">here</a>.</p>
<p><img src="images/shinytest2-loadtest.png" width="100%" style="display: block; margin: auto;"></p>
<p>As shown in the above report, especially in the session duration tab, the app is clearly not able to handle 5 simultaneous user due to the very large computations being performed by the Shiny server:</p>
<ul>
<li>The red area is over represented for most sessions, which means many users have to wait significant amount of time before seeing the app. This is a critical issue, most users will leave the app at this moment.</li>
<li>The blue area is also large, showing that most time is spent for computations. Given the single-threaded nature of R, there are high chances other users might be blocked by already ongoing computations. This is also frustrating, as people may think the app has crashed.</li>
</ul>
<p>Even though out of this vignette scope, one quick and significant optimization would be to set a caching <a href="https://shiny.rstudio.com/articles/caching.html" class="external-link">system</a> with <code>shiny::bind_cache()</code>. As shown in the following figure, adding cache is so fast that <code>shinycannon</code> was able to start more than 1000 sessions in 2 minutes.</p>
<p><img src="images/shinytest2-shinyloadtest-optimized.png" width="100%" style="display: block; margin: auto;"></p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="http://schloerke.com" class="external-link">Barret Schloerke</a>, RStudio.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

  </div></footer>
</body>
</html>
