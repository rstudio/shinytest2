<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>CLAUDE.md • shinytest2</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="icon" sizes="any" href="favicon.ico"><link rel="manifest" href="site.webmanifest"><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet"><link href="deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="CLAUDE.md"><meta property="og:image" content="https://rstudio.github.io/shinytest2/logo.svg"></head><body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">shinytest2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="articles/shinytest2.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/in-depth.html">Testing in depth</a></li>
    <li><a class="dropdown-item" href="articles/robust.html">Robust testing</a></li>
    <li><a class="dropdown-item" href="articles/use-application-audit.html">Auditing Shiny apps</a></li>
    <li><a class="dropdown-item" href="articles/use-ci.html">Using shinytest2 with continuous integration</a></li>
    <li><a class="dropdown-item" href="articles/use-package.html">Using shinytest2 with R packages</a></li>
    <li><a class="dropdown-item" href="articles/using-monkey-testing.html">Monkey testing</a></li>
    <li><a class="dropdown-item" href="articles/z-migration.html">Migrating from shinytest</a></li>
    <li><a class="dropdown-item" href="articles/zzz-faq.html">Frequently Asked Questions</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rstudio/shinytest2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body" id="container">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="logo.svg" class="logo" alt=""><h1>CLAUDE.md</h1>
      <small class="dont-index">Source: <a href="https://github.com/rstudio/shinytest2/blob/rc-v0.5.0/CLAUDE.md" class="external-link"><code>CLAUDE.md</code></a></small>
    </div>

<div id="claudemd" class="section level1">

<p>This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.</p>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a></h2>
<p>shinytest2 is an R package that provides automated testing for Shiny applications using a headless Chromium browser via the chromote package. It integrates with testthat for snapshot-based testing of Shiny apps.</p>
</div>
<div class="section level2">
<h2 id="core-architecture">Core Architecture<a class="anchor" aria-label="anchor" href="#core-architecture"></a></h2>
<div class="section level3">
<h3 id="main-components">Main Components<a class="anchor" aria-label="anchor" href="#main-components"></a></h3>
<ul><li>
<p><strong>AppDriver (R6 class)</strong>: The central testing interface defined in <a href="R/app-driver.R">R/app-driver.R</a>. This R6 class manages:</p>
<ul><li>Launching Shiny apps in background R processes (via callr)</li>
<li>Controlling a headless Chrome browser (via chromote)</li>
<li>Capturing app state (inputs, outputs, exports)</li>
<li>Taking screenshots and executing JavaScript</li>
<li>Waiting for reactivity to stabilize</li>
</ul></li>
<li><p><strong>Test Recording</strong>: <a href="R/record-test.R">R/record-test.R</a> implements an interactive test recorder that launches a special Shiny app to record user interactions and generate test code automatically.</p></li>
<li><p><strong>Expectations</strong>: The package provides several expectation methods split across files like <a href="R/app-driver-expect-values.R">R/app-driver-expect-values.R</a>, <a href="R/app-driver-expect-screenshot.R">R/app-driver-expect-screenshot.R</a>, etc. These wrap testthat’s snapshot functions.</p></li>
</ul></div>
<div class="section level3">
<h3 id="key-design-patterns">Key Design Patterns<a class="anchor" aria-label="anchor" href="#key-design-patterns"></a></h3>
<ol style="list-style-type: decimal"><li><p><strong>Split R6 Methods</strong>: The AppDriver R6 class is split across multiple files (app-driver-*.R) for maintainability. Each file handles a specific aspect (expectations, waiting, JavaScript execution, etc.).</p></li>
<li><p><strong>Background Processes</strong>: Shiny apps run in separate R processes via callr to isolate them from the testing environment.</p></li>
<li><p><strong>Chromote Integration</strong>: The package heavily uses chromote to control a headless Chrome browser for realistic user interaction simulation.</p></li>
<li><p><strong>Snapshot Testing</strong>: Integrates with testthat’s snapshot testing infrastructure. Snapshots are stored in tests/testthat/_snaps/.</p></li>
<li><p><strong>Test Mode</strong>: Shiny apps must run with <code>test.mode = TRUE</code> to expose internal values via <code><a href="https://rdrr.io/pkg/shiny/man/exportTestValues.html" class="external-link">shiny::exportTestValues()</a></code>.</p></li>
</ol></div>
</div>
<div class="section level2">
<h2 id="common-development-tasks">Common Development Tasks<a class="anchor" aria-label="anchor" href="#common-development-tasks"></a></h2>
<div class="section level3">
<h3 id="running-tests">Running Tests<a class="anchor" aria-label="anchor" href="#running-tests"></a></h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run all package tests</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">test</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run specific test file</span></span>
<span><span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_file.html" class="external-link">test_file</a></span><span class="op">(</span><span class="st">"tests/testthat/test-app-driver.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run tests with filter</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">test</span><span class="op">(</span>filter <span class="op">=</span> <span class="st">"screenshot"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="building-the-package">Building the Package<a class="anchor" aria-label="anchor" href="#building-the-package"></a></h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load package for development</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">load_all</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check package</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">check</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build documentation</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">document</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build website</span></span>
<span><span class="fu">pkgdown</span><span class="fu">::</span><span class="fu"><a href="https://pkgdown.r-lib.org/reference/build_site.html" class="external-link">build_site</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="testing-during-development">Testing During Development<a class="anchor" aria-label="anchor" href="#testing-during-development"></a></h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create an AppDriver for interactive testing</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/shinytest2/">shinytest2</a></span><span class="op">)</span></span>
<span><span class="va">app</span> <span class="op">&lt;-</span> <span class="va"><a href="reference/AppDriver.html">AppDriver</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"path/to/app"</span><span class="op">)</span></span>
<span><span class="va">app</span><span class="op">$</span><span class="fu">view</span><span class="op">(</span><span class="op">)</span>  <span class="co"># Opens browser for visual inspection</span></span>
<span><span class="va">app</span><span class="op">$</span><span class="fu">get_values</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">app</span><span class="op">$</span><span class="fu">set_inputs</span><span class="op">(</span>input_name <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span>
<span><span class="va">app</span><span class="op">$</span><span class="kw">stop</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="working-with-c-code">Working with C++ Code<a class="anchor" aria-label="anchor" href="#working-with-c-code"></a></h3>
<p>The package includes C++ code (in src/) compiled via cpp11. After modifying C++ code:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Rebuild and reload package</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">load_all</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="important-implementation-details">Important Implementation Details<a class="anchor" aria-label="anchor" href="#important-implementation-details"></a></h2>
<div class="section level3">
<h3 id="appdriver-lifecycle">AppDriver Lifecycle<a class="anchor" aria-label="anchor" href="#appdriver-lifecycle"></a></h3>
<ol style="list-style-type: decimal"><li>
<code>$new()</code> initializes the driver:
<ul><li>Starts background R process with Shiny app</li>
<li>Launches ChromoteSession</li>
<li>Injects shiny-tracer.js for monitoring</li>
<li>Optionally waits for app to stabilize</li>
</ul></li>
<li>
<code>$stop()</code> cleans up:
<ul><li>Stops Shiny process (SIGINT → SIGTERM → SIGKILL)</li>
<li>Closes ChromoteSession</li>
<li>Cleans up logs if requested</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="waiting-mechanisms">Waiting Mechanisms<a class="anchor" aria-label="anchor" href="#waiting-mechanisms"></a></h3>
<ul><li>
<code>$wait_for_idle()</code>: Waits for Shiny to be idle (no reactivity) for a specified duration</li>
<li>
<code>$wait_for_value()</code>: Waits for a specific input/output/export to have a non-ignored value</li>
<li>
<code>$wait_for_js()</code>: Waits for JavaScript expression to evaluate to true</li>
<li>All set_inputs() calls wait by default until an output updates</li>
</ul></div>
<div class="section level3">
<h3 id="screenshot-comparison">Screenshot Comparison<a class="anchor" aria-label="anchor" href="#screenshot-comparison"></a></h3>
<ul><li>Default selector changed in v0.3.0 from <code>"html"</code> to <code>"scrollable_area"</code>
</li>
<li>
<code><a href="reference/compare_screenshot_threshold.html">compare_screenshot_threshold()</a></code> in <a href="R/compare-screenshot-threshold.R">R/compare-screenshot-threshold.R</a> provides threshold-based comparison using convolution to handle minor pixel differences</li>
<li>Screenshots are platform-dependent; use <code>variant = platform_variant()</code> for cross-platform testing</li>
</ul></div>
<div class="section level3">
<h3 id="test-file-organization">Test File Organization<a class="anchor" aria-label="anchor" href="#test-file-organization"></a></h3>
<ul><li>Package follows standard R package structure with tests in tests/testthat/</li>
<li>Recorded tests typically saved as test-app-<appname>.R</appname></li>
<li>Support files (helper functions, data) should go in tests/testthat/ and are loaded via <code><a href="reference/app_support.html">load_app_support()</a></code>
</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="migration-from-shinytest">Migration from shinytest<a class="anchor" aria-label="anchor" href="#migration-from-shinytest"></a></h2>
<p>This package replaces the deprecated shinytest package. Key function: <code><a href="reference/migrate_from_shinytest.html">migrate_from_shinytest()</a></code> in <a href="R/migrate.R">R/migrate.R</a> converts old shinytest tests to shinytest2 format.</p>
</div>
<div class="section level2">
<h2 id="logging-and-debugging">Logging and Debugging<a class="anchor" aria-label="anchor" href="#logging-and-debugging"></a></h2>
<ul><li>
<code>$get_logs()</code> returns a data.frame with timestamped logs from three sources:
<ul><li>“shinytest2”: AppDriver logging via <code>$log_message()</code>
</li>
<li>“shiny”: stdout/stderr from the background Shiny process</li>
<li>“chromote”: Browser console, exceptions, and WebSocket traffic (if <code>options(shiny.trace = TRUE)</code>)</li>
</ul></li>
<li>Set <code>options(shiny.trace = TRUE)</code> in the app’s options to capture all WebSocket messages</li>
</ul></div>
<div class="section level2">
<h2 id="cicd">CI/CD<a class="anchor" aria-label="anchor" href="#cicd"></a></h2>
<p>The package uses rstudio/shiny-workflows GitHub Actions: - R-CMD-check runs on multiple platforms - Website deployment via pkgdown - Test apps can be tested in CI using the custom action at actions/test-app</p>
</div>
<div class="section level2">
<h2 id="testing-philosophy">Testing Philosophy<a class="anchor" aria-label="anchor" href="#testing-philosophy"></a></h2>
<ul><li>Prefer <code>$expect_values()</code> over <code>$expect_screenshot()</code> for robustness</li>
<li>Prefer <code>$expect_text()</code> over <code>$expect_html()</code> to avoid brittleness from internal DOM changes</li>
<li>Use <code>$expect_screenshot()</code> sparingly as screenshots are very brittle to:
<ul><li>R version changes</li>
<li>OS differences</li>
<li>Font differences</li>
<li>Package version updates</li>
</ul></li>
</ul></div>
<div class="section level2">
<h2 id="package-dependencies">Package Dependencies<a class="anchor" aria-label="anchor" href="#package-dependencies"></a></h2>
<p>Critical dependencies to be aware of: - <strong>chromote</strong> (≥ 0.5.0): Browser automation - <strong>testthat</strong> (≥ 3.3.1): Testing framework - <strong>callr</strong>: Background R processes - <strong>shiny</strong>: The framework being tested - <strong>cpp11</strong>: C++ integration for performance-critical operations</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="http://schloerke.com" class="external-link">Barret Schloerke</a>, Posit Software, PBC.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

  </div></footer></body></html>

